<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>TGI Kubernetes 007: Controller ë§Œë“¤ê¸° | äººç”Ÿã¯çŸ­ãã¦ä½¿ãˆã‚‹æ™‚é–“ã‚‚é™ã‚‰ã‚Œã¦ã‚‹ã€‚</title>



<link href="https://ziwon.github.io/index.xml" rel="alternate" type="application/rss+xml" title="äººç”Ÿã¯çŸ­ãã¦ä½¿ãˆã‚‹æ™‚é–“ã‚‚é™ã‚‰ã‚Œã¦ã‚‹ã€‚" />
<link rel='stylesheet' href='https://ziwon.github.io/css/style-kiss.css'><link rel='stylesheet' href='https://ziwon.github.io/css/custom.css'><link rel='stylesheet' href='https://ziwon.github.io/css/syntax-github.css'><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">


<link rel=â€œstylesheetâ€ type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/styles/hybrid.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/highlight.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/bash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/go.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/rust.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.9/languages/scala.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>


<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://ziwon.github.io/">
          <h1 class="title is-4">äººç”Ÿã¯çŸ­ãã¦ä½¿ãˆã‚‹æ™‚é–“ã‚‚é™ã‚‰ã‚Œã¦ã‚‹ã€‚</h1>
        </a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="twitter" href='https://twitter.com/theluno'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="github" href='https://github.com/ziwon'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:yngpil.yoon@gmail.com'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="instagram" href='https://instagram.com/ziwon.y'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"/>
    <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>
<section class="section">
  <div class="container">
    <article>
      <h1 class="title"><a href="https://ziwon.github.io/post/tgik-007/">TGI Kubernetes 007: Controller ë§Œë“¤ê¸°</a></h1>
      <h2 class="subtitle is-6">2019-03-03 </h2>
      <div class="subtitle tags is-6 is-pulled-right">
        
        
<a class="subtitle is-6" href="/tags/kubernetes">#Kubernetes</a>



  
  | <a class="subtitle is-6" href="/tags/controller">#controller</a>
  

        
      </div>
      <div class="content">
        

<p><a href="https://github.com/heptio/tgik/blob/master/episodes/007/README.md" target="_blank">ì¼ê³± ë²ˆì§¸ ì—í”¼ì†Œë“œ</a>ëŠ” ê°„ë‹¨í•˜ê²Œ ì¿ ë²„ë„¤í‹°ìŠ¤ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ ë³´ëŠ” ë°ëª¨ì´ë‹¤.</p>

<p>ë°ëª¨ ë¦¬í¬ì§€í† ë¦¬ê°€ ì˜¤ë˜ë˜ê³  API íŒ¨í‚¤ì§€ëª…ì´ ë‹¤ë¥´ê¸°ë„ í•˜ê³  í•˜ì—¬, <code>go mod</code> ê¸°ë°˜ìœ¼ë¡œ ì¬ì‘ì„±í•˜ì˜€ë‹¤. ì €ì¥ì†Œì—ëŠ” ë°ëª¨ì— í•´ë‹¹í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ì†ŒìŠ¤ê°€ ê°ê° <code>pod-watcher</code>ì™€ <code>secret-controller</code>ì˜ ë‘ ê°€ì§€ë¡œ íƒœê¹…ë˜ì–´ ìˆë‹¤.</p>

<ul>
<li><a href="https://github.com/ziwon/k8s-controller" target="_blank">ziwon/k8s-controller</a></li>
</ul>

<p>ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ëŠ” <a href="https://github.com/kubernetes-sigs/kind" target="_blank">kind</a>ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸í•˜ì˜€ë‹¤.</p>

<ul>
<li><a href="https://github.com/ziwon/yak8s" target="_blank">ziwon/yak8s</a></li>
</ul>

<h2 id="pod-ì»¨íŠ¸ë¡¤ëŸ¬">Pod ì»¨íŠ¸ë¡¤ëŸ¬</h2>

<p>ë¨¼ì €, ì ë‹¹í•œ ë””ë ‰í† ë¦¬ì— ì €ì¥ì†Œë¥¼ í´ë¡ í•œë‹¤. ê·¸ë¦¬ê³  <code>pod-watcher</code>ë¥¼ ì²´í¬ ì•„ì›ƒí•œë‹¤. (<code>go mod</code>ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ ì—¬ê¸°ì„œëŠ” ìƒëµí•©ë‹ˆë‹¤.)</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">export</span> <span class="nv">GO111MODULE</span><span class="o">=</span>auto
$ git clone git@github.com:ziwon/k8s-controller.git
$ git checkout pod-watcher</code></pre></div>
<p>ë‹¤ìŒìœ¼ë¡œ, ë¡œì»¬ PC í™˜ê²½ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ ë„ìš´ë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ git clone https://github.com/ziwon/yak8s
$ make kind-cluster-up
Creating cluster <span class="s1">&#39;kind-1&#39;</span> ...
 âœ“ Ensuring node image <span class="o">(</span>kindest/node:v1.13.2<span class="o">)</span> ğŸ–¼
 âœ“ <span class="o">[</span>lb<span class="o">]</span> Creating node container ğŸ“¦
 âœ“ <span class="o">[</span>lb<span class="o">]</span> Fixing mounts ğŸ—»
 âœ“ <span class="o">[</span>lb<span class="o">]</span> Starting systemd ğŸ–¥
 âœ“ <span class="o">[</span>lb<span class="o">]</span> Waiting <span class="k">for</span> docker to be ready ğŸ‹
 âœ“ <span class="o">[</span>lb<span class="o">]</span> Pre-loading images ğŸ‹
 âœ“ <span class="o">[</span>control-plane1<span class="o">]</span> Creating node container ğŸ“¦
 âœ“ <span class="o">[</span>control-plane1<span class="o">]</span> Fixing mounts ğŸ—»
 âœ“ <span class="o">[</span>control-plane1<span class="o">]</span> Starting systemd ğŸ–¥
 âœ“ <span class="o">[</span>control-plane1<span class="o">]</span> Waiting <span class="k">for</span> docker to be ready ğŸ‹
 âœ“ <span class="o">[</span>control-plane1<span class="o">]</span> Pre-loading images ğŸ‹
 ...
 âœ“ <span class="o">[</span>lb<span class="o">]</span> Starting the external load balancer â›µ
 âœ“ <span class="o">[</span>control-plane1<span class="o">]</span> Creating the kubeadm config file â›µ
 âœ“ <span class="o">[</span>control-plane1<span class="o">]</span> Starting Kubernetes <span class="o">(</span>this may take a minute<span class="o">)</span> â˜¸
 âœ“ <span class="o">[</span>control-plane2<span class="o">]</span> Joining control-plane node to Kubernetes â˜¸
 âœ“ <span class="o">[</span>worker1<span class="o">]</span> Joining worker node to Kubernetes â˜¸
 âœ“ <span class="o">[</span>worker2<span class="o">]</span> Joining worker node to Kubernetes â˜¸
 âœ“ <span class="o">[</span>worker3<span class="o">]</span> Joining worker node to Kubernetes â˜¸
 âœ“ <span class="o">[</span>worker4<span class="o">]</span> Joining worker node to Kubernetes â˜¸
Cluster creation complete. You can now use the cluster with:

<span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>kind get kubeconfig-path --name<span class="o">=</span><span class="s2">&#34;1&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
kubectl cluster-info
/Library/Developer/CommandLineTools/usr/bin/make kind-cluster-info
Kubernetes master is running at https://localhost:63578
KubeDNS is running at https://localhost:63578/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</code></pre></div>
<p>í´ëŸ¬ìŠ¤í„°ë¥¼ ë„ì› ìœ¼ë‹ˆ, ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì‚¬ìš©í•  <code>KUBECONFIG</code> í™˜ê²½ë³€ìˆ˜ë¥¼ ì¡ì•„ì¤€ë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>kind get kubeconfig-path --name<span class="o">=</span><span class="s2">&#34;1&#34;</span><span class="k">)</span><span class="s2">&#34;</span></code></pre></div>
<p>ì´ì œ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì‹¤í–‰ì‹œì¼œë³´ì. ë‹¤ìŒê³¼ ê°™ì´ í´ëŸ¬ìŠ¤í„° ë‚´ì˜ Pod ì»´í¬ë„ŒíŠ¸ ì •ë³´ë“¤ì´ ì»¨íŠ¸ë¡¤ëŸ¬ ìºì‹œì— ì‹±í¬ë˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ <span class="nb">cd</span> ziwon/k8s-controller
$ git checkout pod-watcher
$ go run *.go
Alias tip: gor *.go
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 k8s-controller version UNKNOWN
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 waiting <span class="k">for</span> cache sync
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/weave-net-ctjpn
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-apiserver-kind-1-control-plane1
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-proxy-mkvq5
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-scheduler-kind-1-control-plane2
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-proxy-r88qg
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-proxy-gs25r
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/weave-net-x2jcn
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/weave-net-qpw2p
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-proxy-qxct5
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/etcd-kind-1-control-plane1
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/coredns-86c58d9df4-w8s8q
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/etcd-kind-1-control-plane2
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-apiserver-kind-1-control-plane2
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-scheduler-kind-1-control-plane1
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-controller-manager-kind-1-control-plane2
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-controller-manager-kind-1-control-plane1
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-proxy-lrjws
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/weave-net-rpfnw
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/coredns-86c58d9df4-8g2s2
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/kube-proxy-tw8ld
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/weave-net-ljdnm
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 onAdd: kube-system/weave-net-vl2nw
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 caches are synced
<span class="m">2019</span>/03/03 <span class="m">15</span>:12:15 waiting <span class="k">for</span> stop signal</code></pre></div>
<p>í´ëŸ¬ìŠ¤í„°ì— Podë¥¼ í•˜ë‚˜ ë°°í¬í•œë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ make run-kuard
kubectl run --restart<span class="o">=</span>Never --image<span class="o">=</span>gcr.io/kuar-demo/kuard-amd64:blue kuard
pod/kuard created</code></pre></div>
<p>ë‹¤ìŒê³¼ ê°™ì´ ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ìƒˆë¡œ ë°°í¬ëœ Podê°€ ì¶”ê°€ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="m">2019</span>/03/03 <span class="m">15</span>:13:30 onAdd: default/kuard
<span class="m">2019</span>/03/03 <span class="m">15</span>:13:30 onUpdate: default/kuard
<span class="m">2019</span>/03/03 <span class="m">15</span>:13:30 onUpdate: default/kuard
<span class="m">2019</span>/03/03 <span class="m">15</span>:13:36 onUpdate: default/kuard</code></pre></div>
<p>ì´ì œ ë°°í¬ëœ Podì„ í´ëŸ¬ìŠ¤í„°ì—ì„œ ì œê±°í•˜ë©´, ì—­ì‹œ ì‚­ì œë˜ì—ˆë‹¤ëŠ” ì´ë²¤íŠ¸ë¥¼ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í†µí•´ ìˆ˜ì‹ í•˜ê²Œ ëœë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl delete po kuard</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="m">2019</span>/03/03 <span class="m">15</span>:16:19 onUpdate: default/kuard
<span class="m">2019</span>/03/03 <span class="m">15</span>:16:19 onDelete: default/kuard</code></pre></div>
<p>ì´ìƒ, ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë™ì‘ì„ ê°„ë‹¨íˆ í™•ì¸í•´ ë³´ì•˜ë‹¤. í´ëŸ¬ìŠ¤í„°ì—ëŠ” ì—¬ëŸ¬ ê°œì˜ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë¶™ì¼ ìˆ˜ ìˆìœ¼ë©°, ë‹¨ì§€ ê°ê°ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ë™ì¼í•œ ì‘ì—…ì„ í•˜ì§€ ì•Šìœ¼ë©´ ë¬¸ì œ ì—†ë‹¤ê³  í•œë‹¤. ë˜í•œ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ì—¬ëŸ¬ ì–¸ì–´ë¡œ ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆê¸° ë•Œë¬¸ì—, êµ³ì´ Goì–¸ì–´ë¡œ ì‘ì„±ë  í•„ìš”ëŠ” ì—†ë‹¤ê³  í•œë‹¤.</p>

<p>ë°˜ì‘í˜• ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•œ ì—¬ëŸ¬ê°€ì§€ ìœ í‹¸ë¦¬í‹°ì™€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìˆìœ¼ë©°, í•œ ê°€ì§€ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤ ì¤‘ í•˜ë‚˜ëŠ” Queueë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ë‹¤. í´ëŸ¬ìŠ¤í„° ìì²´ê°€ ë§¤ìš° burstyí•˜ê³  ì—¬ëŸ¬ ê°€ì§€ ë³€ê²½ì´ ë§¤ìš° ë§ê¸° ë•Œë¬¸ì—, í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ëª¨ë“  ë³€ê²½ì„ í•˜ë‚˜ì”© ì¼ì¼íˆ ì²˜ë¦¬í•˜ê¸° ë³´ë‹¤ëŠ” ë¹„ìŠ·í•œ ì¢…ë¥˜ì˜ ë³€ê²½ë“¤ì€ í•˜ë‚˜ë¡œ ë¬¶ì–´ì„œ íë¥¼ í†µí•´ ì²˜ë¦¬í•˜ê²Œ ë˜ë©´, rate limitì„ ì‚¬ìš©í•´ì„œ í´ëŸ¬ìŠ¤í„° ë³€ê²½ì— ëŒ€í•´ ì„œë²„ê°€ ì–¼ë§ˆë‚˜ ì„¸ê²Œ ì¹˜ëŠ”ì§€ ì•Œ ìˆ˜ ìˆë‹¤ê³  í•œë‹¤. ì´ë¥¼ ìœ„í•´ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ë¼ì´ì–¸íŠ¸ì—ì„œ <strong><a href="https://github.com/kubernetes/client-go/tree/master/examples/workqueue" target="_blank">Workqueue</a></strong>ë¥¼ ì œê³µí•˜ê³  ìˆë‹¤.</p>

<h3 id="pod-watcher-ì½”ë“œ-ì„¤ëª…">Pod-Watcher ì½”ë“œ ì„¤ëª…</h3>

<p>ì´ì œ ì½”ë“œë¥¼ ê°„ë‹¨íˆ ì‚´í´ë³´ì.</p>

<p>ë‹¤ìŒì€ <code>k8s-controller.go</code> íŒŒì¼ì—ì„œ ì„¤ì • íŒŒì¼ì„ ì¡ì•„ì£¼ëŠ” ë¶€ë¶„ìœ¼ë¡œ,</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">	<span class="k">if</span> <span class="nx">kubeconfig</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nx">BuildConfigFromFlags</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">kubeconfig</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">config</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">InClusterConfig</span><span class="p">()</span>
	<span class="p">}</span></code></pre></div>
<p>ìœ„ ì½”ë“œëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í´ë¼ì´ì–¸íŠ¸ë¥¼ <code>KUBECONFIG</code> í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” <code>kubeconfig</code> í”Œë˜ê·¸ë¥¼ í†µí•´ì„œ ì„¤ì •í•˜ê±°ë‚˜ ë˜ëŠ” ë§Œì•½ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ë‚´ì— ìˆë‹¤ë©´, ê¸°ë³¸ê°’ìœ¼ë¡œ restClientë¥¼ ì„¤ì •í•˜ê²Œ ëœë‹¤.</p>

<p>ë‹¤ìŒìœ¼ë¡œ ì„¤ì •ëœ í™˜ê²½ë³€ìˆ˜ì— ëŒ€í•´ ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ë¥¼ ìƒì„±í•œë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">client</span> <span class="o">:=</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">NewForConfigOrDie</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span></code></pre></div>
<p>ê·¸ë¦¬ê³  <code>sharedInformer</code>ë¥¼ ìƒì„±í•˜ëŠ”ë°, ì¿ ë²„ë„¤í‹°ìŠ¤ ì˜¤ë¸Œì íŠ¸ì— ëŒ€í•œ ë¯¸ëŸ¬ë¥¼ ìºì‹œí•˜ë‹¤ê°€ íŠ¹ì • ì˜¤ë¸Œì íŠ¸ì˜ ë³€ê²½ì´ ìˆìœ¼ë©´ ì•Œë ¤ì£¼ëŠ” ì£¼ëŠ” ì—­í• ì„ í•œë‹¤. ì¿ ë²„ë„¤í‹°ìŠ¤ ë‚´ì—ì„œëŠ” ê°ê° ìì‹ ë“¤ë§Œì˜ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì¿ ë²„ë„¤í‹°ìŠ¤ ê°ì²´ì— ëŒ€í•´ ë¯¸ëŸ¬ë¥¼ ìœ ì§€í•˜ëŠ”ë°, ì´ëŠ” ë§¤ìš° í° í´ëŸ¬ìŠ¤í„°ì˜ ê²½ìš° ë§¤ìš° ë©”ëª¨ë¦¬ ì§‘ì•½ì ì¸ ì‘ì—…ì´ë‹¤. ë”°ë¼ì„œ ì—¬ëŸ¬ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ê³µìœ í•´ì„œ ì‚¬ìš©í•˜ëŠ” ë­”ê°€ê°€ í•„ìš”í•œë°, <code>SharedInformer</code>ê°€ ê·¸ ì—­í• ì„ í•œë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">	<span class="nx">sharedInformers</span> <span class="o">:=</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>
	<span class="nx">k8sController</span> <span class="o">:=</span> <span class="nx">NewK8SController</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">sharedInformers</span><span class="p">.</span><span class="nx">Core</span><span class="p">().</span><span class="nx">V1</span><span class="p">().</span><span class="nx">Pods</span><span class="p">())</span></code></pre></div>
<p>ì´ì œ, <code>controller.go</code>ì˜ ì†ŒìŠ¤ë¥¼ ì‚´í´ë³´ì.</p>

<p>ë¨¼ì € <code>podGetter</code>ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í´ë¼ì´ì–¸íŠ¸ë¥¼ í†µí•´ í•´ë‹¹ Pod ì •ë³´ë¥¼ íšë“í•˜ê³ , <code>podLister</code>ëŠ” <code>SharedInformer</code>ì˜ ìºì‹œë¥¼ í†µí•´ Pod ëª©ë¡ì„ íšë“í•œë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">K8SController</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">podGetter</span>       <span class="nx">corev1</span><span class="p">.</span><span class="nx">PodsGetter</span>
	<span class="nx">podLister</span>       <span class="nx">listercorev1</span><span class="p">.</span><span class="nx">PodLister</span>
	<span class="nx">podListerSynced</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">InformerSynced</span>
<span class="p">}</span></code></pre></div>
<p>ë‹¤ìŒìœ¼ë¡œ <code>SharedInformer</code>ì— ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì¶”ê°€í•œë‹¤. ì´ ë¶€ë¶„ì€ ì´ë²¤íŠ¸ ì˜µì €ë²„ íŒ¨í„´ì˜ ì¼ë°˜ì ì¸ í˜•ì‹ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">	<span class="nx">podInformer</span><span class="p">.</span><span class="nx">Informer</span><span class="p">().</span><span class="nx">AddEventHandler</span><span class="p">(</span>
		<span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
			<span class="nx">AddFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
				<span class="nx">c</span><span class="p">.</span><span class="nx">onAdd</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
			<span class="p">},</span>
			<span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
				<span class="nx">c</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">(</span><span class="nx">oldObj</span><span class="p">,</span> <span class="nx">newObj</span><span class="p">)</span>
			<span class="p">},</span>
			<span class="nx">DeleteFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
				<span class="nx">c</span><span class="p">.</span><span class="nx">onDelete</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
			<span class="p">},</span>
		<span class="p">},</span>
	<span class="p">)</span></code></pre></div>
<p>ê·¸ë¦¬ê³ , <code>onAdd</code>, <code>onUpdate</code>, <code>onDelete</code> ë“± ê°ê°ì˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ êµ¬í˜„í•œë‹¤. <code>cache.MetaNamespaceKeyFunc</code>ëŠ” <code>default/kuard</code>ì—ì„œì²˜ëŸ¼, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ê°ì²´ì˜ ì´ë¦„ì„ ë°”ì¸ë”©í•œ ê°’ì„ ìºì‰¬ì— ëŒ€í•œ í‚¤ë¡œ ê°€ì ¸ì˜¨ë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">K8SController</span><span class="p">)</span> <span class="nx">onAdd</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;onAdd: object: %#v: %v&#34;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
	<span class="nx">key</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">MetaNamespaceKeyFunc</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;onAdd: error getting key for: %#v: %v&#34;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="nx">runtime</span><span class="p">.</span><span class="nx">HandleError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;onAdd: %v&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<p>ë‹¤ìŒì€ ìºì‹œ ì‹±í¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤. ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê³ , ë§Œì•½ íë¥¼ ì´ìš©í•œë‹¤ë©´, ì‹±í¬ ì „ì— íë¥¼ ë¡œë”©í•´ì£¼ê³  ì›Œì»¤ë¥¼ ì‹¤í–‰í•´ì•¼í•œë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">K8SController</span><span class="p">)</span> <span class="nx">Run</span><span class="p">(</span><span class="nx">stop</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&#34;waiting for cache sync&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">cache</span><span class="p">.</span><span class="nx">WaitForCacheSync</span><span class="p">(</span><span class="nx">stop</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">podListerSynced</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&#34;timed out waiting for cache sync&#34;</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&#34;caches are synced&#34;</span><span class="p">)</span>

	<span class="c1">// wait until we&#39;re told to stop
</span><span class="c1"></span>	<span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&#34;waiting for stop signal&#34;</span><span class="p">)</span>
	<span class="o">&lt;-</span><span class="nx">stop</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&#34;received stop signal&#34;</span><span class="p">)</span>
<span class="p">}</span></code></pre></div>
<h2 id="secret-copy-ì»¨íŠ¸ë¡¤ëŸ¬">Secret Copy ì»¨íŠ¸ë¡¤ëŸ¬</h2>

<p>ë‹¤ìŒìœ¼ë¡œ ì‘ì„±í•´ ë³¼ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ì‹œí¬ë¦¿ ì»¨íŠ¸ë¡¤ëŸ¬ì´ë‹¤.</p>

<p>ì˜ˆë¥¼ ë“¤ì–´, ì—¬ëŸ¬ ê°œë°œìê°€ ì‚¬ìš©í•˜ëŠ” ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„°ë¥¼ ì…‹ì—…í–ˆê³ , ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë§ˆë‹¤ ê°œë°œìë¥¼ í• ë‹¹í•˜ì—¬ ë­”ê°€ë¥¼ í•œë‹¤ê³  í•  ë•Œ, ê³µìœ  ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ê°œë°œìë“¤ì—ê²Œ ì¿ ë²„ë„¤í‹°ìŠ¤ ì‹œí¬ë¦¿ì„ ëª¨ë“  ê°œë°œìë“¤ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì „íŒŒí•˜ëŠ” ê²ƒì´ ì´ìŠˆê°€ ë  ìˆ˜ ìˆë‹¤. ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì´ë¥¼í…Œë©´, ì¼ì¢…ì˜ ì‹œí¬ë¦¿ì„ ê° ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë³µì‚¬í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤.</p>

<p>ìì„¸í•œ ì†ŒìŠ¤ ì½”ë“œëŠ” <code>secret-controller</code> íƒœê·¸ë¥¼ ì°¸ê³ í•œë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ git checkout secret-controller</code></pre></div>
<p>ì†ŒìŠ¤ë¥¼ ë³´ë©´, Secret ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•œ ì´ë²¤íŠ¸ë¥¼ í•¸ë“¤ë§í•˜ëŠ” <strong><a href="https://github.com/ziwon/k8s-controller/blob/secret-controller/controller.go#L110" target="_blank">handleSecretChange(obj interface{})</a></strong> ì»¨íŠ¸ë¡¤ëŸ¬ ë©”ì†Œë“œê°€ ì¶”ê°€ë˜ì—ˆë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">K8SController</span><span class="p">)</span> <span class="nx">handleSecretChange</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
	<span class="nx">secret</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">obj</span><span class="p">.(</span><span class="o">*</span><span class="nx">apicorev1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="c1">// TODO: this is probably a `DeletedFinalStateUnknown`.  Figure out what
</span><span class="c1"></span>		<span class="c1">// to do.
</span><span class="c1"></span>		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">secret</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">Namespace</span> <span class="o">!=</span> <span class="nx">secretSyncSourceNamespace</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;Skipping secret in wrong namespace&#34;</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">secret</span><span class="p">.</span><span class="nx">Type</span> <span class="o">!=</span> <span class="nx">secretSyncType</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;Skipping secret of wrong type&#34;</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;Do something with this secret&#34;</span><span class="p">)</span>
	<span class="nx">nsList</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">namespaceGetter</span><span class="p">.</span><span class="nx">Namespaces</span><span class="p">().</span><span class="nx">List</span><span class="p">(</span><span class="nx">metav1</span><span class="p">.</span><span class="nx">ListOptions</span><span class="p">{})</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;Error listeing namespaces: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ns</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">nsList</span><span class="p">.</span><span class="nx">Items</span> <span class="p">{</span>
		<span class="nx">nsName</span> <span class="o">:=</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">Name</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">namespaceBlacklist</span><span class="p">[</span><span class="nx">nsName</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;Skipping namespace on blacklist: %v&#34;</span><span class="p">,</span> <span class="nx">nsName</span><span class="p">)</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&#34;We should copy %s to namespace %s&#34;</span><span class="p">,</span> <span class="nx">secret</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">ns</span><span class="p">.</span><span class="nx">ObjectMeta</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">copySecretToNamespace</span><span class="p">(</span><span class="nx">secret</span><span class="p">,</span> <span class="nx">nsName</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>ì‹œí¬ë¦¿ì„ ë³µì‚¬í•  ë•Œ, <code>kube-public</code>, <code>kube-system</code> ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” ì œì™¸í•œ ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ë³µì‚¬í•˜ëŠ” ì‘ì—…ì„ ìˆ˜í–‰í•˜ê³  ìˆë‹¤. ì‹¤ì œ ì‹œí¬ë¦¿ì„ ë³µì‚¬í•˜ëŠ” ì½”ë“œëŠ” ì‹œê°„ê´€ê³„ìƒ ìƒëµë˜ì—ˆì§€ë§Œ, ê·¸ êµ¬í˜„ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ì´ ì£¼ì„ì„ ì°¸ê³ í•œë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">K8SController</span><span class="p">)</span> <span class="nx">copySecretToNamespace</span><span class="p">(</span><span class="nx">secret</span> <span class="o">*</span><span class="nx">apicorev1</span><span class="p">.</span><span class="nx">Secret</span><span class="p">,</span> <span class="nx">nsName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// TODO:
</span><span class="c1"></span>	<span class="c1">// 1. Make a deep copy of the secret
</span><span class="c1"></span>	<span class="c1">// 2. Remove things like object version that&#39;ll prevent us from writing
</span><span class="c1"></span>	<span class="c1">// 3. Write in new namespace
</span><span class="c1"></span>	<span class="c1">// 4. Do a create or update for the new object
</span><span class="c1"></span><span class="p">}</span></code></pre></div>
<p>ì´ì œ, í´ëŸ¬ìŠ¤í„°ì— <code>secretsync</code>ë¼ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ë§Œë“ ë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl create namespace secretsync</code></pre></div>
<p>ì‹œí¬ë¦¿ì„ ë§Œë“œëŠ” ë°©ë²•ê³¼ ê´€ë ¨ëœ ì˜µì…˜ì€ ë‹¤ìŒê³¼ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl create --namespace<span class="o">=</span>secretsync secret generic --help
Create a secret based on a file, directory, or specified literal value.

A single secret may package one or more key/value pairs.

When creating a secret based on a file, the key will default to the basename of the file, and the
value will default to the file content. If the basename is an invalid key or you wish to chose your
own, you may specify an alternate key.

When creating a secret based on a directory, each file whose basename is a valid key in the
directory will be packaged into the secret. Any directory entries except regular files are ignored
<span class="o">(</span>e.g. subdirectories, symlinks, devices, pipes, etc<span class="o">)</span>.

Examples:
  <span class="c1"># Create a new secret named my-secret with keys for each file in folder bar
</span><span class="c1"></span>  kubectl create secret generic my-secret --from-file<span class="o">=</span>path/to/bar

  <span class="c1"># Create a new secret named my-secret with specified keys instead of names on disk
</span><span class="c1"></span>  kubectl create secret generic my-secret --from-file<span class="o">=</span>ssh-privatekey<span class="o">=</span>~/.ssh/id_rsa
--from-file<span class="o">=</span>ssh-publickey<span class="o">=</span>~/.ssh/id_rsa.pub

  <span class="c1"># Create a new secret named my-secret with key1=supersecret and key2=topsecret
</span><span class="c1"></span>  kubectl create secret generic my-secret --from-literal<span class="o">=</span><span class="nv">key1</span><span class="o">=</span>supersecret
--from-literal<span class="o">=</span><span class="nv">key2</span><span class="o">=</span>topsecret

  <span class="c1"># Create a new secret named my-secret using a combination of a file and a literal
</span><span class="c1"></span>  kubectl create secret generic my-secret --from-file<span class="o">=</span>ssh-privatekey<span class="o">=</span>~/.ssh/id_rsa
--from-literal<span class="o">=</span><span class="nv">passphrase</span><span class="o">=</span>topsecret

  <span class="c1"># Create a new secret named my-secret from an env file
</span><span class="c1"></span>  kubectl create secret generic my-secret --from-env-file<span class="o">=</span>path/to/bar.env</code></pre></div>
<p>ìœ„ ê°€ì´ë“œ ë©”ì„¸ì§€ë¥¼ ë”°ë¼, , <code>--from-literal</code> ì˜µì…˜ìœ¼ë¡œ, <code>--type</code>ì˜ ê°’ì€ <code>k8s.ziwon.dev/secretsync</code>ì´ê³ , ì´ë¦„ì´ <code>supersecret</code>ì¸ ì‹œí¬ë¦¿ì„ ìƒì„±í•œë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl create --namespace<span class="o">=</span>secretsync secret generic supersecret --from-literal<span class="o">=</span><span class="nv">ziwon</span><span class="o">=</span>awesome --type<span class="o">=</span>k8s.ziwon.dev/secretsync
secret/supersecret created</code></pre></div>
<p>ë§Œë“¤ì–´ì§„ ì‹œí¬ë¦¿ì€ ë‹¤ìŒê³¼ ê°™ì´ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl get secrets
NAME                  TYPE                                  DATA   AGE
default-token-vhc89   kubernetes.io/service-account-token   <span class="m">3</span>      12m
supersecret           k8s.ziwon.dev/secretsync              <span class="m">1</span>      11m</code></pre></div>
<p>ì‹œí¬ë¦¿ ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì‹¤í–‰í•˜ë©´, ë‹¤ìŒê³¼ ê°™ì´ <code>secretsync/supersecret</code>ì— ëŒ€í•´ í•¸ë“¤ë§í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì˜ ë™ì‘ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ go run *.go
...
<span class="m">2019</span>/03/03 <span class="m">18</span>:09:22 onAdd: secretsync/supersecret
<span class="m">2019</span>/03/03 <span class="m">18</span>:09:22 Do something with this secret
<span class="m">2019</span>/03/03 <span class="m">18</span>:09:22 We should copy supersecret to namespace default</code></pre></div>
<p>ì´ìƒ, ê°„ë‹¨í•˜ê²Œ Pod Watcher ì»¨íŠ¸ë¡¤ëŸ¬ì™€ Secret Copy ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ë§Œë“¤ì–´ ë³´ì•˜ë‹¤.</p>

<h2 id="ê¸°íƒ€">ê¸°íƒ€</h2>

<ul>
<li><a href="https://engineering.bitnami.com/articles/a-deep-dive-into-kubernetes-controllers.html" target="_blank">A Deep Dive Into Kubernetes Controllers</a></li>
</ul>

        
        <div class="related">

<h3>Similar articles:</h3>
<ul>
	
	<li><a href="/post/tgik-006/">TGI Kubernetes 006: kubeadm</a></li>
	
	<li><a href="/post/tgik-005/">TGI Kubernetes 005: Pod Params and Probes</a></li>
	
	<li><a href="/post/tgik-004/">TGI Kubernetes 004: RBAC</a></li>
	
	<li><a href="/post/tgik-003/">TGI Kubernetes 003: Istio</a></li>
	
	<li><a href="/post/tgik-002/">TGI Kubernetes 002: Networking and Services</a></li>
	
</ul>
</div>
        
      </div>
    </article>
    

    
    <nav class="post-nav">
        
        <a class="prev" href="/post/cosmos-intro/">
            &lt; <span class="prev-text nav-default">Cosmosë€ ë¬´ì—‡ì¸ê°€</span>
                <span class="prev-text nav-mobile"></span>
        </a>
        
        <a class="next" href="/post/docker-storage-volumes/">
            <span class="next-text nav-default">[ë²ˆì—­] ë„ì»¤ ë³¼ë¥¨</span>
            <span class="next-text nav-mobile"></span>
            >
        </a>
    </nav>

  </div>
 
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'ziwon';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p><a href="https://github.com/ziwon">Youngpil Yoon</a></p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-129419926-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>




</body>
</html>

